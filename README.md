# Security Guard | 2FA With operations that using PAM

Это пошаговое руководство поможет вам установить и настроить систему двухфакторной аутентификации с нуля на чистом сервере Ubuntu/Debian.

## Шаг 1: Подготовка системы

Обновите пакеты и установите необходимые зависимости для сборки:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y build-essential libpam0g-dev pkg-config libssl-dev curl git
```

## Шаг 2: Установка Rust

Установите компилятор Rust через официальный скрипт:

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```
*Нажмите `1` (default installation) при запросе.*

После установки примените изменения в текущей сессии:
```bash
source $HOME/.cargo/env
echo 'source $HOME/.cargo/env' >> ~/.bashrc
```
## Шаг 3: Настройка проекта

1. Перейдите в папку проекта:
   ```bash
   cd ~/security_guard
   ```

2. Настройте конфигурацию бэкенда:
   ```bash
   cd telegram_backend
   cp .env.example .env
   nano .env
   ```
   *Впишите ваш `TELOXIDE_TOKEN` (от @BotFather) и ваш `ADMIN_IDS` (можно узнать у @userinfobot).*

## Шаг 4: Сборка и запуск бэкенда

Бэкенд должен работать постоянно, чтобы принимать запросы от PAM-модуля.

1. Соберите бэкенд:
   ```bash
   cargo build --release
   ```

2. Рекомендуется запустить его через `screen` или `tmux`, чтобы он не закрылся при выходе из консоли:
   ```bash
   sudo apt install screen -y
   screen -S tg_auth
   ./target/release/telegram_backend
   ```
   *Нажмите `Ctrl+A`, затем `D`, чтобы отсоединиться от экрана (бэкенд продолжит работу).*

## Шаг 5: Сборка и установка PAM-модуля

1. Перейдите в корень проекта и соберите модуль:
   ```bash
   cd ~/security_guard
   cargo build --release -p pam_module
   ```

2. Установите модуль в системную директорию:
   ```bash
   sudo cp target/release/libpam_module.so /lib/x86_64-linux-gnu/security/pam_telegram.so
   ```

## Шаг 6: Активация 2FA в системе

**ВНИМАНИЕ!** Ошибка на этом шаге может заблокировать доступ к серверу. Держите открытой одну сессию с root-правами для отката изменений.

### Для SSH (вход в систему):
1. Откройте конфиг:
   ```bash
   sudo nano /etc/pam.d/sshd
   ```
2. Добавьте в самое начало (перед всеми другими правилами):
   ```text
   auth required pam_telegram.so
   ```

### Для sudo (подтверждение команд):
1. Откройте конфиг:
   ```bash
   sudo nano /etc/pam.d/sudo
   ```
2. Добавьте в самое начало:
   ```text
   auth required pam_telegram.so
   ```

## Шаг 7: Проверка

1. Попробуйте выполнить любую команду через `sudo` или зайдите на сервер через новое SSH-соединение.
2. В консоли появится надпись `Verification Code:`.
3. В Telegram придет сообщение с кодом и деталями (IP, сервис).
4. Введите код. Если код верный — система запросит ваш обычный пароль.

## Решение проблем

- **Segmentation Fault**: Обычно означает, что модуль не может достучаться до бэкенда. Проверьте, запущен ли `telegram_backend` на порту 8080.
- **Код не приходит**: Проверьте `.env` файл и логи бэкенда.
- **Бан**: Если вы ввели код неверно, ваш IP заблокирован на 15 минут. Вы можете перезапустить бэкенд, чтобы сбросить список банов.

## Безопасность и Fail-Safe

В модуле реализован механизм **Fail-Safe**: если бэкенд недоступен или произошла сетевая ошибка, модуль автоматически пропустит вас в систему (вернув `SUCCESS`), чтобы вы не потеряли доступ к серверу при технических неполадках бота.
